<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android Gradle Multi Flavors | Septenary Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android Gradle Multi Flavors</h1><a id="logo" href="/.">Septenary Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android Gradle Multi Flavors</h1><div class="post-meta">Nov 8, 2015<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><div class="post-content"><p>我们用 <strong>Gradle</strong> 构建多个渠道包，而且这些渠道包都是有差异的，可能是包名不同，可能是代码不同，也可能是资源不同，<strong>flavors</strong>  这个概念由此产生，用  <strong>flavors</strong> 来配置构建脚本 <strong>build.gradle</strong> ，可以构建 Android 工程的多个变种</p>
<h2 id="最简单的-flavors-配置"><a href="#最简单的-flavors-配置" class="headerlink" title="最简单的 flavors 配置"></a>最简单的 flavors 配置</h2><p>在 <strong>build.gradle</strong> 文件中，构建多个变种，最简单的配置如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">productFlavors &#123;</span><br><span class="line">	googlePlay &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	appStore &#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 <code>gradle build</code> 后你会看见，<strong>./output/apk 文件夹</strong> 下生成了 <strong>googlePlay</strong> 和 <strong>appStore</strong> 两种 APK 文件，接下来就以这两个变种为例，详细介绍下如何配置 <strong>flavors</strong></p>
<a id="more"></a>
<h2 id="多个包名"><a href="#多个包名" class="headerlink" title="多个包名"></a>多个包名</h2><p>下面配置的 <code>applicationId</code> 会在打包时替换 <strong>AndroidManifest.xml</strong> 中的 <code>package=&quot;xx.xx&quot;</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">productFlavors &#123;</span><br><span class="line">	googlePlay &#123;</span><br><span class="line">			applicationId <span class="string">'cn.septenary.mulityflavors_googlePlay'</span></span><br><span class="line">	&#125;</span><br><span class="line">	appStore &#123;</span><br><span class="line">			applicationId <span class="string">'cn.septenary.mulityflavors_appStore'</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="多个BuildConfig"><a href="#多个BuildConfig" class="headerlink" title="多个BuildConfig"></a>多个BuildConfig</h2><p><strong>BuildConfig</strong> 是 Android 构建的时候自动生成配置文件，最常用的就是常量 <code>BuildConfig.DEBUG</code> ，便于开发者区分不同的版本来编写不同的代码，下面代码介绍了在 <strong>BuildConfig</strong> 中根据不同的 <strong>flavor</strong>  配置不同的自定义常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">productFlavors &#123;</span><br><span class="line">	googlePlay &#123;</span><br><span class="line">			buildConfigField <span class="string">"String"</span>,<span class="string">"SotreName"</span>,<span class="string">"\"Google 应用商店\""</span></span><br><span class="line">	&#125;</span><br><span class="line">	appStore &#123;</span><br><span class="line">			buildConfigField <span class="string">"String"</span>,<span class="string">"SotreName"</span>,<span class="string">"\"苹果 应用商店\""</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，<code>buildConfigField</code> 需要三个变量，第一个参数定义了<strong>常量类型</strong>，第二个参数为<strong>常量名</strong>，第三个参数定义了<strong>常量值</strong>，这里需要注意第三个参数，由于定义的常量是 String 类型，所以用到了 <code>\&quot;</code>进行转义，在代码中访问 <code>BuildConfig.SotreName</code>  就可以拿到不同 <strong>flavor</strong> 对应的 <code>SotreName</code> 的值了。</p>
<h2 id="同时修改多个-flavor"><a href="#同时修改多个-flavor" class="headerlink" title="同时修改多个 flavor"></a>同时修改多个 flavor</h2><p>如果你的项目多个flavor用到了同一个配置，可以这样写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">productFlavors.all &#123; flavor -&gt;</span><br><span class="line">	<span class="comment">// replace all buildConfigField -&gt; SotreName</span></span><br><span class="line">	flavor.buildConfigField <span class="string">'String'</span>, <span class="string">'SotreName'</span>, <span class="string">'"默认商店名"'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="多资源"><a href="#多资源" class="headerlink" title="多资源"></a>多资源</h2><p>如果一个应用，在不同的渠道需要不同的启动图或者文字提示，flavor 同样可以帮我们完成。</p>
<p>1.首先，Android Studio 的工程目录默认地将源代码和资源都放在了 <strong>src/main</strong> 文件夹下，在 <strong>main</strong> 的同级目录，也就是  <strong>src</strong> 文件夹下创建全路径文件 <strong>src/googlePlay/res/values/strings.xml</strong>，（注意：路径中的 “googlePlay” 必须与 flavor 名称一一对应），这个文件代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"app_name"</span>&gt;</span>Flavor: Google Play<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.同样地，创建全路径文件 <strong>src/appStore/res/values/strings.xml</strong>，配置下面的代码:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"app_name"</span>&gt;</span>Flavor: App Store<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">```    </span><br><span class="line"></span><br><span class="line">3.在java源代码中调用 `getResources().getString(R.string.hello_flavor)` ，不同的 flavor 构建成的 APK 运行起来打印出的结果便不同了</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.如果想要替换其他资源，同样地按照 **src + flavor名称 + 对应要修改的文件** 这种方式，都可以完成，这种方式同样适用于替换源代码（类名，包名必须保持一致）</span><br><span class="line"></span><br><span class="line">占位符 Placeholder</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">如果你想在代码中从 **AndroidManifest.xml **，通过不同的 flavor 读取不同的 **meta-data** 值，该如何实现呢？</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**Placeholder** 占位符 这个概念，可以帮我们完成，下面是如何使用占位符的示例：</span><br><span class="line"></span><br><span class="line">1.在 **AndroidManifest** 文件中配置：</span><br><span class="line"> </span><br><span class="line"> ```xml</span><br><span class="line"><span class="tag">&lt;<span class="name">application</span>&gt;</span>;</span><br><span class="line">	<span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">		<span class="attr">android:name</span>=<span class="string">"CHANNEL"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">android:value</span>=<span class="string">"$&#123;CHANNEL_VALUE&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>其中 <code>${CHANNEL_VALUE}</code> 为占位符，下面通过这个这个占位符对不同的 flavor 进行配置</p>
<p>2.在 <strong>build.config</strong> 中配置占位符：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">defaultConfig &#123;</span><br><span class="line">	<span class="comment">// Placeholder</span></span><br><span class="line">	manifestPlaceholders = [<span class="string">CHANNEL_VALUE:</span> <span class="string">'channel_testing'</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">productFlavors.all &#123; flavor -&gt;</span><br><span class="line">	<span class="comment">// replace all placeholders</span></span><br><span class="line">	flavor.manifestPlaceholders.put(<span class="string">"CHANNEL_VALUE"</span>, name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">productFlavors &#123;</span><br><span class="line">	googlePaly &#123;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	appStore &#123;</span><br><span class="line">		...</span><br><span class="line">		manifestPlaceholders.put(<span class="string">"CHANNEL_VALUE"</span>, <span class="string">'channel_appstore'</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="指定-APK-输出"><a href="#指定-APK-输出" class="headerlink" title="指定 APK 输出"></a>指定 APK 输出</h2><p>默认地，<code>gradle build</code> 构建出来的 APK 是构建系统默认设置的名字，如果我们想要 APK 的名字追加生成时间、指定生成路径，改怎么办呢？</p>
<p>1.定义函数 buildTime</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> buildTime() &#123;</span><br><span class="line">	<span class="keyword">def</span> date = <span class="keyword">new</span> Date()</span><br><span class="line">	<span class="keyword">def</span> formattedDate = date.format(<span class="string">'yyyy-MM-dd'</span>)</span><br><span class="line">	<span class="keyword">return</span> formattedDate</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码要放在与 <strong>android {…}</strong> 同级下，而不是嵌入在 <strong>android{…}</strong> 中</p>
<p>2.全局配置</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">applicationVariants.all &#123; variant -&gt;</span><br><span class="line">	variant.outputs.each &#123; output -&gt;</span><br><span class="line">		<span class="keyword">def</span> parent = output.outputFile.parent;</span><br><span class="line">		<span class="keyword">def</span> apkName = <span class="string">"$&#123;variant.flavorName&#125;_$&#123;variant.versionName&#125;_$&#123;buildTime()&#125;.apk"</span></span><br><span class="line">		output.outputFile = <span class="keyword">new</span> File(parent, apkName);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.针对与某个 <strong>buildType</strong> 配置</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">	release &#123;</span><br><span class="line">			...</span><br><span class="line">	&#125;</span><br><span class="line">	debug &#123;</span><br><span class="line">		applicationVariants.all &#123; variant -&gt;</span><br><span class="line">			variant.outputs.each &#123; output -&gt;</span><br><span class="line">				<span class="keyword">if</span> (output.outputFile != <span class="literal">null</span> </span><br><span class="line">				&amp;&amp; output.outputFile.name.endsWith(<span class="string">'.apk'</span>) </span><br><span class="line">				&amp;&amp;<span class="string">'debug'</span>.equals(variant.buildType.name)&#123;</span><br><span class="line">						<span class="keyword">def</span> parent = output.outputFile.getParent();</span><br><span class="line">						<span class="keyword">def</span> apkName = <span class="string">"$&#123;variant.flavorName&#125;_$&#123;variant.versionName&#125;_$&#123;buildTime()&#125;.apk"</span></span><br><span class="line">						<span class="keyword">def</span> apkFile = <span class="keyword">new</span> File(parent,apkName)</span><br><span class="line">						output.outputFile = apkFile</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>我在 <a href="https://github.com/Ryfthink/Android-Gradle-Mulity-Flavor" target="_blank" rel="noopener">Github</a> 上发布了一个 <strong>Demo</strong> 供大家参考</p>
<h2 id="部分参考"><a href="#部分参考" class="headerlink" title="部分参考"></a>部分参考</h2><p><a href="http://stackoverflow.com/questions/20976946/dynamically-generating-product-flavors" target="_blank" rel="noopener">Dynamically generating product flavors</a></p>
</div><div class="tags"></div><div class="post-nav"><a class="pre" href="/2015/12/10/android-tv-dimention-adaption/">Android 盒子适配解决办法汇总</a><a class="next" href="/2015/08/15/quickshot-option-notwork-in-android/">AndroidStudio Option 快捷键失效</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'b9c9fa93919f96a68da2',
  clientSecret: 'a6f794fb428cf3622e117143d47e3dc9950b937f',
  repo: 'blog-comment',
  owner: 'ryfthink',
  admin: ['ryfthink'],
  distractionFreeMode: false,
  id: location.pathname
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Chore/">Chore</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/RN/">RN</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/devOps/">devOps</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/github/">github</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/">mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/它山之石/">它山之石</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/05/30/如何像天才一样说俏皮话？/">如何像天才一样说俏皮话？</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/18/pub-clipkg-npm-repo/">Publishing cli-package to npm repository</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/25/react-native-tutorial/">ReactNative Tutorial</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/elasticsearch-delete-indices-period/">ElasticSearch 定期删除过期索引</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/23/logstash-mapping-config/">Logstash Mapping 配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/16/logstash-pipeline-config/">Logstash Pipeline 配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/05/node-login-module/">mean.septenary.cn 搭建之登录逻辑梳理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/24/logstash-intergration-aliyun-oss-plugin/">Logstash 集成 aliyun/oss 插件</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/17/filebeats-in-logstash/">Logstash 之 filebeats</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/16/how-to-intergration-logstash-plugin-2/">Logstash 插件集成</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://mean.septenary.cn" title="MEAN栈博客" target="_blank">MEAN栈博客</a><ul></ul><a href="https://www.jianshu.com/u/af0f90bf5ff5" title="馒头映像" target="_blank">馒头映像</a><ul></ul><a href="https://ryfthink.github.io/azhong/" title="AZhongArtist" target="_blank">AZhongArtist</a><ul></ul><a href="https://www.jianshu.com/u/67eb55a34561" title="剑老湿" target="_blank">剑老湿</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Septenary Blog</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.2.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>